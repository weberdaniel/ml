#include <algorithm>

#include "xtensor/xarray.hpp"
#include "xtensor/xfixed.hpp"
#include "xtensor/xnoalias.hpp"
#include "xtensor/xstrided_view.hpp"
#include "xtensor/xtensor.hpp"
#include "xtensor/xview.hpp"
#include "xtensor-blas/xlinalg.hpp"

using namespace xt::placeholders;
using namespace xt;

int main() {

// py_a
xarray<double> py_a = {{0.3745401188473625,0.9507143064099162,0.7319939418114051},
		       {0.5986584841970366,0.1560186404424365,0.1559945203362026},
		       {0.0580836121681995,0.8661761457749352,0.6011150117432088},
		       {0.7080725777960455,0.0205844942958024,0.9699098521619943},
		       {0.8324426408004217,0.2123391106782762,0.1818249672071006},
		       {0.1834045098534338,0.3042422429595377,0.5247564316322378}};
// py_resq1_h = res_q1[0]
xarray<double> py_resq1_h = {{-1.315298721665117 , 0.3542695728401418, 0.0343722790456067,
			       0.4190178144924799, 0.492616586175736 , 0.1085337284576868},
			     {-0.5678770947978737, 1.2223138676385652,-0.5073775633545012,
			       0.3838046167052854, 0.3339455785740942,-0.0869071101793682},
			     {-1.0163710885529542, 0.7215655008695084, 0.7854784971183754,
			      -0.8184018010449026, 0.3355103841692941,-0.2743559826773575}};
// py_resq1_tau = res_q1[1]
xarray<double> py_resq1_tau = {1.2847566964660386,1.3124991842889797,1.0766465015522177};

auto res1 = linalg::qr(py_a, linalg::qrmode::raw);
allclose(std::get<0>(res1), py_resq1_h);
allclose(std::get<1>(res1), py_resq1_tau);

// py_resq2_q_cmpl = res_q2[0]
xarray<double> py_resq2_q_cmpl = {{-0.2847566964660386, 0.6455031901264898,-0.0295327810119746,
				   -0.5849049416686275,-0.0730618203174816,-0.3923203408230153},
				  {-0.4551502060605352,-0.0838170448559193,-0.3133472182914375,
				    0.08192454532703  ,-0.7892351407115685, 0.240879171458724 },
				  {-0.0441600156766425, 0.68812005380517  , 0.0760152664601147,
				    0.7143224973945711, 0.0235700722943727, 0.0891638112668338},
				  {-0.5383359431077779,-0.2332659103773061, 0.7525061466150681,
				    0.14476921002634  ,-0.0279639819291247,-0.2603378924852557},
				  {-0.6328924578795162,-0.1203177215897516,-0.4769214096589269,
				    0.1040507467269485, 0.5878955555305322, 0.0326957112268429},
				  {-0.1394394344284398, 0.1841243791750923, 0.3185019359677401,
				   -0.330353243868553 , 0.1575155429538277, 0.8433664457979998}};
// py_resq2_r_cmpl = res_q2[1]
xarray<double> py_resq2_r_cmpl = {{-1.315298721665117 ,-0.5678770947978737,-1.0163710885529542},
				  { 0.                , 1.2223138676385652, 0.7215655008695084},
				  { 0.                , 0.                , 0.7854784971183754},
				  { 0.                , 0.                , 0.                },
				  { 0.                , 0.                , 0.                },
				  { 0.                , 0.                , 0.                }};

auto res2 = linalg::qr(py_a, linalg::qrmode::complete);
allclose(std::get<0>(res2), py_resq2_q_cmpl);
allclose(std::get<1>(res2), py_resq2_r_cmpl);

// py_resq3_q_cmpl = res_q3[0]
xarray<double> py_resq3_q_cmpl = {{-0.2847566964660386, 0.6455031901264898,-0.0295327810119746},
				  {-0.4551502060605352,-0.0838170448559193,-0.3133472182914375},
				  {-0.0441600156766425, 0.68812005380517  , 0.0760152664601147},
				  {-0.5383359431077779,-0.2332659103773061, 0.7525061466150681},
				  {-0.6328924578795162,-0.1203177215897516,-0.4769214096589269},
				  {-0.1394394344284398, 0.1841243791750923, 0.3185019359677401}};
// py_resq3_r_cmpl = res_q3[1]
xarray<double> py_resq3_r_cmpl = {{-1.315298721665117 ,-0.5678770947978737,-1.0163710885529542},
				  { 0.                , 1.2223138676385652, 0.7215655008695084},
				  { 0.                , 0.                , 0.7854784971183754}};

auto res3 = linalg::qr(py_a, linalg::qrmode::reduced);
allclose(std::get<0>(res3), py_resq3_q_cmpl);
allclose(std::get<1>(res3), py_resq3_r_cmpl);

// py_resq4_r_r = res_q4
xarray<double> py_resq4_r_r = {{-1.315298721665117 ,-0.5678770947978737,-1.0163710885529542},
			       { 0.                , 1.2223138676385652, 0.7215655008695084},
			       { 0.                , 0.                , 0.7854784971183754}};

auto res4 = linalg::qr(py_a, linalg::qrmode::r);
allclose(std::get<1>(res4), py_resq4_r_r);

return 0;
}
